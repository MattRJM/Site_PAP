<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Redefinir Senha — Sistema de Votação Escolar</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/style.css">

  <style>
    /* Evita que o conteúdo suba por baixo da navbar fixa */
    body.auth-wrapper {
      padding-top: 90px !important;
    }
  </style>
</head>

<body class="auth-wrapper">

<!-- ================= NAVBAR ================= -->
<nav class="navbar navbar-expand-lg fixed-top shadow-sm">
  <div class="container">
    <a class="navbar-brand text-primary" href="index.html">Votação Escolar</a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="menu">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="index.html">Início</a></li>
      </ul>
      <button id="theme-toggle" class="btn btn-outline-primary ms-3"></button>
    </div>
  </div>
</nav>
<!-- ========================================== -->

<div class="auth-container">
  <h3 class="text-center mb-3">Redefinir Senha</h3>

  <div id="info" class="mb-3 text-center text-muted">Carregando informações...</div>

  <form id="resetForm">
    <div class="mb-3">
      <label for="novaSenha" class="form-label">Nova Senha</label>
      <input type="password" class="form-control" id="novaSenha" minlength="6" placeholder="Mínimo 6 caracteres" required>
    </div>

    <button id="btnSubmit" type="submit" class="btn btn-primary w-100">Salvar Nova Senha</button>
  </form>

  <p class="text-center mt-3">
    <a href="login.html">Voltar ao Login</a>
  </p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/theme.js"></script> <!-- Dark mode toggle -->

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
  import {
    getAuth,
    verifyPasswordResetCode,
    confirmPasswordReset
  } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCE_WPEt7T9eqqjlgrJCssWw2KZmmHcDxA",
    authDomain: "pap---votacao.firebaseapp.com",
    projectId: "pap---votacao",
    storageBucket: "pap---votacao.firebasestorage.app",
    messagingSenderId: "940095484879",
    appId: "1:940095484879:web:80cfed4fbe2fea8fe058ba",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Toast simples
  function showToast(msg, type = "info") {
    let container = document.querySelector(".toast-container");
    if (!container) {
      container = document.createElement("div");
      container.className = "toast-container position-fixed top-0 end-0 p-3";
      document.body.appendChild(container);
    }
    const toastEl = document.createElement("div");
    const bgColor = {
      success: "bg-success text-white",
      error: "bg-danger text-white",
      info: "bg-primary text-white",
      warning: "bg-warning text-dark"
    }[type] || "bg-primary text-white";
    toastEl.className = `toast align-items-center ${bgColor} border-0 shadow mt-2 show`;
    toastEl.innerHTML = `<div class="d-flex"><div class="toast-body fw-semibold">${msg}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    container.appendChild(toastEl);
    setTimeout(() => {
      toastEl.classList.remove("show");
      setTimeout(() => toastEl.remove(), 300);
    }, 3000);
  }

  // Pega o código da URL
  const params = new URLSearchParams(window.location.search);
  const oobCode = params.get("oobCode");

  const infoEl = document.getElementById("info");
  const form = document.getElementById("resetForm");
  const btn = document.getElementById("btnSubmit");
  const senhaInput = document.getElementById("novaSenha");

  if (!oobCode) {
    infoEl.textContent = "Link inválido. O código de redefinição (oobCode) não foi encontrado.";
    showToast("Link de redefinição inválido.", "error");
    btn.disabled = true;
  } else {
    verifyPasswordResetCode(auth, oobCode)
      .then((email) => {
        infoEl.innerHTML = `Redefinir senha para <strong>${email}</strong>`;
      })
      .catch((err) => {
        console.error("verifyPasswordResetCode error:", err);
        if (err.code === "auth/expired-action-code") {
          infoEl.textContent = "Este link já expirou.";
          showToast("Link expirado.", "error");
        } else {
          infoEl.textContent = "Link inválido.";
          showToast("Link inválido.", "error");
        }
        btn.disabled = true;
      });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    btn.disabled = true;
    btn.textContent = "Aguarde...";

    const novaSenha = senhaInput.value.trim();

    if (novaSenha.length < 6) {
      showToast("A senha deve ter pelo menos 6 caracteres.", "warning");
      btn.disabled = false;
      btn.textContent = "Salvar Nova Senha";
      return;
    }

    try {
      await confirmPasswordReset(auth, oobCode, novaSenha);
      showToast("Senha redefinida com sucesso!", "success");
      setTimeout(() => window.location.href = "login.html", 1200);
    } catch (err) {
      showToast("Erro ao redefinir senha.", "error");
      btn.disabled = false;
      btn.textContent = "Salvar Nova Senha";
    }
  });
</script>

</body>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/script.js"></script>
</html>
